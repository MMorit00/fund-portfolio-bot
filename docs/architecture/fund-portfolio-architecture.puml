@startuml FundPortfolioArchitecture
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Fund Portfolio Bot - 分层与依赖（MVP）

skinparam package {
  FontSize 12
}
skinparam component {
  FontSize 11
}

' ============================
' 按目录划分为 5 层
' ============================

package "src/jobs\n（驱动适配器）" {
  component "Jobs\n- run_dca.py\n- confirm_trades.py\n- fetch_navs.py\n- daily_report.py" as Jobs
}

package "src/app\n（启动与装配）" {
  component "App\n- main.py (CLI: buy/sell/skip-dca/status)\n- wiring.py\n- config.py\n- log.py\n- LocalNavProvider (本地 NAV 实现)" as App
}

package "src/usecases\n（用例 + 端口）" {
  component "Usecases\n- trading/create_trade.py\n- trading/confirm_pending.py\n- dca/run_daily.py\n- dca/skip_date.py\n- portfolio/daily_report.py" as Usecases
  component "Ports (Protocol)\n- TradeRepo\n- FundRepo\n- NavProvider\n- NavRepo\n- DcaPlanRepo\n- AllocConfigRepo\n- ReportSender\n(定义于 ports.py)" as Ports
}

package "src/core\n（领域模型与规则）" {
  component "Core Domain\n- trade.py (Trade)\n- dca_plan.py (DcaPlan)\n- asset_class.py (AssetClass)\n- trading/settlement.py\n- portfolio/rebalance.py" as Core
}

package "src/adapters\n（被驱动适配器）" {
  component "Adapters\n- db/sqlite/trade_repo.py\n- db/sqlite/fund_repo.py\n- db/sqlite/nav_repo.py\n- db/sqlite/dca_plan_repo.py\n- db/sqlite/alloc_config_repo.py\n- datasources/eastmoney_nav.py (占位)\n- notify/discord_report.py" as Adapters
}

' ============================
' 依赖方向：一律向内
' ============================

' 驱动适配器发起流程
Jobs --> App : 定时/命令入口

' app 装配并调用用例
App --> Usecases : 注入依赖后调用 execute()

' usecases 依赖端口与领域模型
Usecases ..> Ports : 通过 Protocol 抽象访问外部能力
Usecases ..> Core : 使用领域模型与业务规则

' 适配器实现端口
Adapters ..> Ports : 实现 Protocol（仓储/数据源/通知）

' app 在装配时依赖适配器实现
App ..> Adapters : wiring 中创建具体实现

note right of App
  NavProvider 实现：LocalNavProvider\n
  - 从 NavRepo 读取本地 NAV（方案 A）\n
  - 不做网络抓取
end note

' ============================
' 文字说明
' ============================

note bottom of Core
  依赖方向：Jobs/App → Usecases → Ports → Core，\n
  Adapters 也依赖 Ports 与 Core，\n
  核心领域（core）不依赖任何外层。
end note

note as Flow
  每日典型流程（简化）：\n
  1) jobs/fetch_navs → （未来）Usecase → Adapters(抓/存净值)\n
  2) jobs/run_dca → RunDailyDca → TradeRepo(新增 pending)\n
  3) jobs/confirm_trades → ConfirmPendingTrades → TradeRepo 确认份额\n
  4) jobs/daily_report → GenerateDailyReport(mode=market) → ReportSender(Discord)\n
  5) app/main.py status → GenerateDailyReport(mode=market)（终端查看）
end note

Flow -[hidden]- Jobs

note bottom of Usecases
  GenerateDailyReport：\n
  - 市值视图：份额×当日 NAV；缺失/NAV<=0 列入缺失并跳过\n
  - 份额视图：保留兼容模式\n
  ConfirmPendingTrades：\n
  - 首选交易日 NAV；缺失回退确认日 NAV；均无效则跳过
end note

@enduml
