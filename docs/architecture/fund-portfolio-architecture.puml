@startuml FundPortfolioArchitecture
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Fund Portfolio Bot - 目录结构与依赖图（MVP）

skinparam package {
  FontSize 12
}
skinparam component {
  FontSize 11
}

' =============================================
' 以实际目录为分组（不使用抽象层名）
' =============================================

package "src/jobs" {
  component "run_dca.py\n生成定投 pending" as JobRunDca
  component "confirm_trades.py\n按净值确认" as JobConfirm
  component "fetch_navs.py\n抓取净值" as JobFetch
  component "daily_report.py\n发送日报" as JobReport
}

package "src/app" {
  component "main.py\n启动入口" as AppMain
  component "wiring.py\n依赖装配(占位)" as AppWiring
  component "config.py\n配置" as AppConfig
  component "log.py\n日志" as AppLog
}

package "src/usecases" {
  component "dca/run_daily.py\nRunDailyDca" as UcRunDca
  component "trading/create_trade.py\nCreateTrade" as UcCreate
  component "trading/confirm_pending.py\nConfirmPendingTrades" as UcConfirm
  component "portfolio/daily_report.py\nGenerateDailyReport" as UcReport
  component "ports.py\n协议定义" as UcPorts
}

package "src/core" {
  component "trade.py\nTrade" as CoreTrade
  component "dca_plan.py\nDcaPlan" as CoreDca
  component "trading/settlement.py\nget_confirm_date" as CoreSettlement
  component "portfolio/rebalance.py\n再平衡工具" as CoreRebalance
  component "asset_class.py\nAssetClass" as CoreAssetClass
}

package "src/adapters" {
  component "db/sqlite/trade_repo.py\nSqliteTradeRepo" as AdpTradeRepo
  component "db/sqlite/nav_repo.py\nSqliteNavRepo" as AdpNavRepo
  component "datasources/eastmoney_nav.py\nEastmoneyNavProvider" as AdpEastmoney
  component "notify/discord_report.py\nDiscordReportSender" as AdpDiscord
}

' =============================================
' 依赖关系（仅核心逻辑，简化展示）
' =============================================

' 入口与装配（占位提示）
AppMain ..> AppWiring : 启动/装配
AppWiring ..> UcCreate : 注入依赖
AppWiring ..> UcConfirm : 注入依赖
AppWiring ..> UcRunDca : 注入依赖
AppWiring ..> UcReport : 注入依赖

' jobs 执行用例
JobRunDca --> UcRunDca : 执行
JobConfirm --> UcConfirm : 执行
JobReport --> UcReport : 执行

' fetch_navs 目前直接依赖适配器（简化）
JobFetch --> AdpEastmoney : 获取净值
JobFetch --> AdpNavRepo : 写入净值

' usecases 使用领域模型/规则
UcRunDca ..> CoreDca
UcRunDca ..> CoreTrade
UcCreate ..> CoreTrade
UcConfirm ..> CoreSettlement
UcReport ..> CoreRebalance
UcReport ..> CoreAssetClass

' usecases 依赖适配器实现（通过 ports 定义）
UcCreate --> AdpTradeRepo
UcRunDca --> AdpTradeRepo
UcConfirm --> AdpTradeRepo
UcConfirm --> AdpEastmoney
UcReport --> AdpDiscord

note as NoteMissing
  说明：图中仅展示当前仓库已有文件。\n
  其他仓储依赖（如 FundRepo / DcaPlanRepo / AllocConfigRepo）\n
  后续补充具体实现后再加入图中。
end note

NoteMissing -[hidden]- UcPorts

' 简要流程说明（不引入外部节点）
note as Flow
  每日流程（简化）：\n
  1) fetch_navs → Adapters(抓/存净值)\n
  2) run_dca → RunDailyDca → TradeRepo(新增 pending)\n
  3) confirm_trades → ConfirmPendingTrades → TradeRepo 确认\n
  4) daily_report → GenerateDailyReport → DiscordReportSender
end note

Flow -[hidden]- JobRunDca

@enduml
