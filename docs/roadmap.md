# 版本规划

## 项目定位

个人基金投资的"影子记账 + 决策辅助系统"。基于官方日度净值，支持定投、再平衡、限额查询等核心功能。

## 版本总览

| 版本 | 状态 | 核心功能 |
|------|------|---------|
| v0.4.2 | ✅ | CSV 导入、NAV 抓取、份额计算、ActionLog |
| v0.4.3 | ✅ | DCA 回填机制、定投推断、事实快照 |
| v0.4.4 | ✅ | 限额 Facts 系��（AKShare） |
| v0.4.5 | ✅ | 账单导入重构（PDF CSV、先分析后导入） |
| v0.5.0 | ✅ | AI 基础架构（单 AI + Tools，标准 Function Calling） |
| v0.5.1 | 🔮 | AI ReAct 模式（多轮思考-行动循环） |
| v0.6.0 | 🔮 | AI 行为分析、周报/月报 |
| v1.x+ | 🔮 | 前端界面、多 Agent 协作（可选） |

---

## v0.5.0 AI 基础架构（已完成）

### 核心目标

搭��� AI 分析能力的基础骨架，验证"单 AI + Tools"模式。

### 实现范围

- [x] AI 客户端封装（OpenAI 兼容协议，支持 GLM-4-Flash/Qwen/DeepSeek）
- [x] Tools 函数定义（query_fund_nav, query_dca_execution, query_restriction_context）
- [x] CLI 入口（`uv run python -m src.cli.ai "查询..."` + Rich 渲染）
- [x] Prompt 模板（系统提示词 + 结构化 JSON 输出）

### 不做

- ❌ 多 Agent 编排
- ❌ 前端界面
- ❌ 修��数据库 Schema

---

## v0.5.1 AI ReAct 模式（规划中）

### 核心目标

升级到 **ReAct 循环模式**：AI 边做边决策，Think → Act → Observe 直到任务完成。

### 架构设计（参考 opencode 项目）

```
外层循环（step 管理）
  └─ 内层处理（流式响应）
       └─ 事件驱动：tool-call → tool-result → finish-step
```

### 实现范围

**核心循环：**
- [ ] `chat_with_loop()` 双层循环架构
- [ ] 终止条件：finish_reason 判断 / max_steps 限制

**稳定性机制：**
- [ ] Doom Loop 检测（同参数调用 3 次触发警告）
- [ ] 指数退避重试（API 错误自动恢复）

**上下文管理：**
- [ ] Part 级状态机（`pending → running → completed/error`）
- [ ] 合成消息注入（工具输出后引导模型聚焦）
- [ ] 消息压缩（Prune 抹除 + Compaction 总结，可选）

**可选增强：**
- [ ] Snapshot Diffing（感知工具副作用，如文件修改）

### 对比

| 维度 | v0.5.0 | v0.5.1 |
|------|--------|--------|
| 调用轮数 | 固定 1-2 轮 | 动态 N 轮（最多 15） |
| 决策模式 | 一次性决定 | 边做边决策 |
| 状态管理 | 无 | Part 级状态机 |
| 容错机制 | 无 | 重试 + Doom Loop 检测 |

### 不做

- ❌ 引入外部 Agent 框架（自研轻量实现）
- ❌ 多 Agent 协作
- ❌ 修改数据库 Schema

---

## v0.6.0 AI 行为分析（待规划）

基于 v0.5 的 AI 基础架构，实现具体分析场景：

- 定投执行分析（执行率、偏离原因）
- 交易行为画像（冲动型/计划型/机会型）
- 周报/月报生成
- 异常归因（限额导致 vs 主动调整）

---

## 未来规划

**v1.x+**（远期）：
- 前端界面（Web/小程序）
- 多 Agent 协作（可选，视 v0.5/v0.6 验证结果）
- 自然语言查询的深度优化

**暂时搁置**：
- NAV 缺失检测与补抓
- 多数据源支持
- 分红再投追踪

**已知数据源限制**（2025-12-25 记录）：
- DCA 执行率分析缺少"分母"：支付宝 CSV 只包含成功确认的交易，无法获取"失败/跳过"记录
- 场景示例：`{"date": "11-08", "status": "SKIPPED", "reason": "余额不足"}` 这类信息 CSV 不提供
- 未来方案：基于 dca_plans 反推"应执行日期"，与 ActionLog 对比得出 missing_dates

---

## AI 设计原则

### 算法 vs AI 分工

```
┌──────────────────────┬──────────────────────────────────────┐
│       规则/算法       │                 AI                   │
├──────────────────────┼──────────────────────────────────────┤
│ • 日期匹配计算        │ • 判断是否归属定投                    │
│ • 金额偏差率          │ • 解释偏差原因（限额/调整）            │
│ • 限购公告查询        │ • 综合多因素做语义判断                 │
│ • 交易模式统计        │ • 向用户提问澄清                      │
├──────────────────────┼──────────────────────────────────────┤
│     可计算/可验证      │         需要理解/判断                 │
└──────────────────────┴──────────────────────────────────────┘
```

### 数据流

```
导入阶段（临时 AI）：
  CSV → 算法 → BillFacts → AI 判断定投归属 → 回填 ActionLog.strategy

分析阶段（常驻 AI）：
  用户提问 → AI → 调用 Tools 查询 ActionLog → 分析 → 给出建议
```

---

## 禁止事项

- ❌ AI 执行交易操作（只给建议）
- ❌ 为 AI 修改数据库 Schema
- ❌ 盘中估值作为核心口径
- ❌ 过早引入多 Agent 复杂架构
