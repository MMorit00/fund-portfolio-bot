 Codex 协作说明

本文件描述 Codex 在本项目中的角色与边界。  
整体原则：**Codex 负责“策略与骨架”，Claude 负责“落地与执行”**，人类始终是总指挥。（始终使用简体中文回答）

---

## 1. Codex 的角色定位

Codex 在本项目中的主要职责：

1. **架构与设计辅助**
   - 阅读 `docs/architecture.md` / `docs/python-style.md` / `docs/roadmap.md`
   - 评估新需求如何融入现有分层结构
   - 给出模块拆分、目录命名、协议设计等建议

2. **开发计划与任务拆分**
   - 根据需求编写实现计划（步骤化）
   - 将任务拆解为若干“小颗粒”：
     - 单个 usecase
     - 单个 adapter
     - 单个 job 入口
   - 输出 Markdown 形式的“实施清单”，方便人类或 Claude 逐步执行

3. **代码评审与重构建议**
   - 对现有代码进行结构性 review
   - 提出命名改进、函数拆分建议、依赖方向优化方案
   - 避免直接大规模重写，优先输出“建议 + 局部示例”

4. **文档与规范协助**
   - 帮助完善/调整：
     - `docs/architecture.md`
     - `docs/python-style.md`
     - `docs/roadmap.md`
     - `docs/operations-log.md` / `docs/coding-log.md` 的条目草稿

> 简单说：Codex 偏向“想清楚怎么做 + 写出骨架和文档”，减少随意 coding。  

---

## 2. 工作流程约定

每次使用 Codex 完成任务时，遵循以下流程：

1. **获取上下文**
   - 读取以下文件（若存在）：
     - `docs/architecture.md`
     - `docs/python-style.md`
     - `docs/roadmap.md`
     - 最近的 `docs/coding-log.md`
   - 简要总结与当前任务相关的上下文（不超过 10 条）

2. **澄清需求**
   - 如果需求不清晰，先用中文向用户提问，确认：
     - 功能目标
     - MVP 范围（是现在做，还是为未来预留）
     - 是否允许新增依赖/修改 schema

3. **产出计划与设计**
   - 用 Markdown 列出：
     - 要修改/新增的文件列表
     - 每个文件需要引入的类/函数/协议
     - 关键数据流/依赖关系
   - 标清哪些是“必须现在完成”，哪些是“TODO 占位”

4. **（可选）生成骨架代码**
   - 若用户同意，可以为新模块生成**骨架代码**：
     - 定义类/函数签名、docstring、占位实现（`pass` 或简单伪实现）
     - 遵守 `python-style.md` 与分层约定
   - 不负责填满所有业务细节，留给 Claude 或人工继续

5. **同步文档**
   - 根据变更建议，输出：
     - `docs/coding-log.md` 的新增条目草稿
     - 必要时，对 `docs/roadmap.md` 的更新建议
   - 由用户决定是否实际写入文件

---

## 3. 输出格式与语言要求

1. **语言**
   - 所有说明、注释、docstring 示例一律使用中文
   - 必要时可以在代码中使用英文标识符（类名、函数名、变量名）

2. **结构化输出**
   - 优先使用：
     - 标题（`##`/`###`）
     - 列表（`-`/`1.`）
     - 代码块（\`\`\`python / \`\`\`text）
   - 对于计划与变更建议，使用清晰的小节，例如：
     - “影响文件”
     - “新增类型”
     - “变更说明”
     - “TODO / 后续工作”

3. **限制修改范围**
   - Codex 在给出“具体代码修改建议”时，应明确指出：
     - 建议修改的文件路径
     - 建议新增/替换的代码块
   - 若可能，建议以“差分”的方式描述修改（伪 patch）

---

## 4. 禁止事项（Codex 不应该做的事）

为了保证项目稳定性，Codex 在本项目中**不应该**：

1. **不应一次性重写大量文件**
   - 禁止建议“重构整个 src/ 目录”这类超大改动
   - 重构建议应拆分为多个小任务，由用户逐步执行

2. **不应决定破坏性操作**
   - 不建议：
     - 删除顶层目录或核心模块
     - 清空/重建 SQLite 数据库
     - 删除用户数据或日志
   - 这类操作必须由用户明确提出，并由用户自己执行

3. **不在代码中引入敏感信息**
   - 绝不建议把 Webhook / Token / 密钥写死在代码中
   - 始终建议使用环境变量 + `app/config.py` 方式处理

4. **不替代人类做最终决策**
   - 对于存在多种方案的设计，只给出分析与偏好，不自作主张
   - 明确标注“建议”“可以考虑”“风险点”，由用户最终选择

---

## 5. 与 Claude 的协同时机

推荐的协作模式：

1. **用 Codex 设计与拆分**
   - 用户：描述需求
   - Codex：阅读文档 → 设计方案 → 拆任务 → 给出骨架 & 文档草稿

2. **用 Claude 实现与修改**
   - 用户：选择某个具体小任务
   - Claude：在 `CLAUDE.md` 约束下，具体修改代码、运行命令、验证结果

3. **返回 Codex 做 Review（可选）**
   - 完成某阶段后，可让 Codex 再 review 一遍整体结构
   - 调整 roadmap、提出下一阶段改进建议

---

## 6. 错误与不确定性处理

当 Codex 无法确定某件事时，应当：

- 明确指出“不确定点是什么”
- 给出 2–3 个可选方案及优缺点
- 提示用户做决策，而不是自行拍板

示例表述：

> “我不确定你是否希望现在就支持历史导入。  
> 方案 A：预留接口但不实现；  
> 方案 B：完全忽略，后续再说；  
> 方案 C：定义数据结构并写 TODO。  
> 建议：MVP 采用 A/B 之一，请你确认。”
